useDotenv: true
service: ${env:SERVERLESS_SERVICE}
frameworkVersion: '3'
configValidationMode: error

provider:
  name: aws
  runtime: nodejs16.x
  region: ap-southeast-1
  memorySize: 256

plugins:
  - serverless-plugin-include-dependencies
  - serverless-localstack

custom:
  localstack:
    stages:
      - local

package:
 individually: true

functions:
  bulk-qrcode-generation:
    handler: src/server/serverless/bulk-qrcode-generation/index.handler
    memorySize: 2048 # 2048 MB
    ephemeralStorageSize: 512 # 512 MB
    timeout: 120 # 120 seconds
    description: Bulk generates QR codes in svg and png from shortUrl-longUrl mappings
    environment:
      ASSET_VARIANT: gov
      DOMAIN: localhost:3000
      EB_CALLBACK_ENDPOINT: http://app:8080/api/callback/qr
      # TODO: change to hardcoded api key by injecting admin user 
      EB_CALLBACK_SECRET: ${env:ADMIN_API_KEY} # .env file
      BULK_GENERATION_BUCKET: local-bucket
      LOCALSTACK_ENDPOINT: http://localstack:4566
      DEV_ENV: true
    package:
      patterns:
        - '!./**'
        - 'src/server/serverless/bulk-qrcode-generation/**'
        - 'package-lock.json'
        - 'package.json'
